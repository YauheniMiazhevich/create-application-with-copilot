services:

  # ---------------------------------------------------------------------------
  # Database – PostgreSQL 16
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-backendapi_dev_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-backendapi_dev_db}"]
      interval: 10s
      timeout: 5s
      start_period: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M

  # ---------------------------------------------------------------------------
  # Backend – ASP.NET Core 8
  # Build context is the workspace root so both backend/ and backend.Tests/ are
  # available (tests run inside the image build and gate the final image).
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Dev
      ASPNETCORE_URLS: http://+:5272
      HTTPS_REDIRECT_ENABLED: "false"
      # Connection string – override each part via env vars
      ConnectionStrings__DefaultConnection: >-
        Host=db;Port=5432;
        Database=${POSTGRES_DB:-backendapi_dev_db};
        Username=${POSTGRES_USER:-postgres};
        Password=${POSTGRES_PASSWORD:-postgres}
      # JWT settings
      JwtSettings__SecretKey: ${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      JwtSettings__Issuer: ${JWT_ISSUER:-BackendApi}
      JwtSettings__Audience: ${JWT_AUDIENCE:-BackendApiClients}
      JwtSettings__ExpirationHours: ${JWT_EXPIRATION_HOURS:-4}
      # CORS – allow requests from the frontend container
      AllowedOrigins__0: ${FRONTEND_ORIGIN:-http://localhost:3000}
    ports:
      - "${BACKEND_PORT:-5272}:5272"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - backend-net
      - frontend-net
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  # ---------------------------------------------------------------------------
  # Frontend – React 19 / nginx 1.27
  # REACT_APP_API_URL is baked into the CRA bundle at build time via ARG.
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:5272/api}
    ports:
      - "${FRONTEND_PORT:-3000}:8080"
    depends_on:
      - backend
    networks:
      - frontend-net
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 64M

# ---------------------------------------------------------------------------
# Named volumes – data survives container restarts and rebuilds
# ---------------------------------------------------------------------------
volumes:
  postgres_data:

# ---------------------------------------------------------------------------
# Networks – backend-net is internal (DB not reachable from host or frontend)
# ---------------------------------------------------------------------------
networks:
  backend-net:
    internal: true
  frontend-net:
